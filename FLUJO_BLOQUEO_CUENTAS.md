# Flujo de Bloqueo de Cuentas - NaivePay
## AnÃ¡lisis Detallado del Mecanismo de ProtecciÃ³n contra Fuerza Bruta

---

## ğŸ“‹ Resumen Ejecutivo

El sistema implementa un mecanismo de **protecciÃ³n contra ataques de fuerza bruta** que bloquea automÃ¡ticamente cuentas despuÃ©s de **5 intentos fallidos consecutivos en una ventana de 30 minutos**.

### ParÃ¡metros de Seguridad
- **MÃ¡ximo de intentos**: 5 fallos
- **Ventana temporal**: 30 minutos
- **Estado de bloqueo**: `AccountState.INACTIVE`
- **Reinicio del contador**: DespuÃ©s de un login exitoso

---

## ğŸ—ï¸ Arquitectura de Componentes

### Clases Involucradas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FLUJO DE BLOQUEO                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. AuthController
   â”œâ”€â”€ Recibe request POST /auth/login
   â””â”€â”€ Delega a AuthService

2. AuthService (Coordinador principal)
   â”œâ”€â”€ Valida credenciales
   â”œâ”€â”€ Verifica estado de cuenta
   â”œâ”€â”€ Coordina bloqueo automÃ¡tico
   â””â”€â”€ Calcula intentos restantes

3. AccountLockService (LÃ³gica de bloqueo)
   â”œâ”€â”€ isAccountLocked(user)
   â”œâ”€â”€ checkAndBlockIfNeeded(user)
   â””â”€â”€ blockAccount(user)

4. AuthAttemptService (AuditorÃ­a)
   â”œâ”€â”€ log(user, device, session, success, reason)
   â”œâ”€â”€ countFailedAttemptsSince(userId, since)
   â””â”€â”€ findLastSuccessAt(userId)

5. AuthAttemptRepository (Persistencia)
   â”œâ”€â”€ findLatestAttemptsByUser(userId, pageable)
   â”œâ”€â”€ countFailedAttemptsSince(userId, since)
   â””â”€â”€ findLastSuccessAt(userId)

6. UserRepository
   â””â”€â”€ save(user) - actualiza estado de cuenta

7. EmailService
   â””â”€â”€ sendAccountBlockedNotice(email)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ENTIDADES DE DATOS                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User
â”œâ”€â”€ id: Long
â”œâ”€â”€ state: AccountState (ACTIVE/INACTIVE)
â”œâ”€â”€ email: String
â””â”€â”€ register: Register

AuthAttempt
â”œâ”€â”€ attId: Long
â”œâ”€â”€ user: User
â”œâ”€â”€ attDeviceFingerprint: String
â”œâ”€â”€ session: Session (nullable)
â”œâ”€â”€ attSuccess: boolean
â”œâ”€â”€ attReason: AuthAttemptReason
â””â”€â”€ attOccurred: Instant

AccountState (Enum)
â”œâ”€â”€ ACTIVE
â””â”€â”€ INACTIVE

AuthAttemptReason (Enum)
â”œâ”€â”€ OK (login exitoso)
â”œâ”€â”€ BAD_CREDENTIALS (contraseÃ±a incorrecta)
â”œâ”€â”€ USER_NOT_FOUND
â”œâ”€â”€ ACCOUNT_BLOCKED
â”œâ”€â”€ DEVICE_UNAUTHORIZED
â””â”€â”€ DEVICE_REQUIRED
```

---

## ğŸ”„ Flujo Detallado del Bloqueo

### 1ï¸âƒ£ INICIO: Usuario intenta hacer login

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /auth/login                                             â”‚
â”‚ {                                                            â”‚
â”‚   "identifier": "usuario@example.com",                       â”‚
â”‚   "password": "contraseÃ±a_incorrecta"                        â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthController.login()                                       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ Recibe LoginRequest y deviceFingerprint                      â”‚
â”‚ Delega a: authService.login(req, deviceFingerprint)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CÃ³digo**: `AuthController.java:18-24`

---

### 2ï¸âƒ£ VALIDACIÃ“N BÃSICA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthService.login() - PASO 1                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ Validar que identifier y password no estÃ©n vacÃ­os           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”œâ”€â–º SI vacÃ­o â†’ 401 UNAUTHORIZED
                            â”‚              (no se registra intento)
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthService.login() - PASO 2                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ Resolver usuario por email o RUT                            â”‚
â”‚ â””â”€â–º resolveUser(identifier)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”œâ”€â–º Usuario NO existe â†’ 401 UNAUTHORIZED
                            â”‚   authAttemptService.log(null, ..., USER_NOT_FOUND)
                            â”‚
                            â–¼ Usuario SÃ existe
```

**CÃ³digo**: `AuthService.java:56-67`

---

### 3ï¸âƒ£ VERIFICACIÃ“N DE BLOQUEO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthService.login() - PASO 3                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ VERIFICAR SI LA CUENTA YA ESTÃ BLOQUEADA                     â”‚
â”‚                                                              â”‚
â”‚ if (accountLockService.isAccountLocked(user)) {              â”‚
â”‚     logFailedAttempt(user, ACCOUNT_BLOCKED);                 â”‚
â”‚     return 403 FORBIDDEN;                                    â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AccountLockService.isAccountLocked(user)                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ return user.getState() == AccountState.INACTIVE;            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”œâ”€â–º SI bloqueada (INACTIVE)
                            â”‚   â””â”€â–º 403 FORBIDDEN
                            â”‚       â””â”€â–º Frontend muestra popup informativo
                            â”‚           "Tu cuenta ha sido bloqueada..."
                            â”‚
                            â–¼ NO bloqueada (ACTIVE)
```

**CÃ³digo**: `AuthService.java:69-73` y `AccountLockService.java:59-61`

---

### 4ï¸âƒ£ VALIDACIÃ“N DE CONTRASEÃ‘A

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthService.login() - PASO 4                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ VALIDAR CONTRASEÃ‘A                                           â”‚
â”‚                                                              â”‚
â”‚ if (!isValidPassword(user, req.getPassword())) {             â”‚
â”‚     // âš ï¸ CONTRASEÃ‘A INCORRECTA - LÃ“GICA DE BLOQUEO          â”‚
â”‚     logFailedAttempt(user, BAD_CREDENTIALS);                 â”‚
â”‚                                                              â”‚
â”‚     // Verificar si debe bloquearse                          â”‚
â”‚     boolean wasBlocked = accountLockService                  â”‚
â”‚                         .checkAndBlockIfNeeded(user);        â”‚
â”‚                                                              â”‚
â”‚     if (wasBlocked) {                                        â”‚
â”‚         return 403 FORBIDDEN (ACCOUNT_BLOCKED);              â”‚
â”‚     }                                                        â”‚
â”‚                                                              â”‚
â”‚     // Calcular intentos restantes                           â”‚
â”‚     int remaining = calculateRemainingAttempts(user);        â”‚
â”‚                                                              â”‚
â”‚     if (remaining == 0) {                                    â”‚
â”‚         accountLockService.blockAccount(user);               â”‚
â”‚         return 403 FORBIDDEN (ACCOUNT_BLOCKED);              â”‚
â”‚     }                                                        â”‚
â”‚                                                              â”‚
â”‚     return 401 UNAUTHORIZED {                                â”‚
â”‚         "error": "BAD_CREDENTIALS",                          â”‚
â”‚         "remainingAttempts": remaining                       â”‚
â”‚     }                                                        â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CÃ³digo**: `AuthService.java:75-101`

---

### 5ï¸âƒ£ LÃ“GICA DE BLOQUEO AUTOMÃTICO

#### 5.1 Verificar si se debe bloquear

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AccountLockService.checkAndBlockIfNeeded(user)               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ ALGORITMO DE DETECCIÃ“N DE BLOQUEO                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 1: Validaciones previas                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ if (user == null) return false;                              â”‚
â”‚ if (isAccountLocked(user)) return false; // Ya bloqueada     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 2: Obtener Ãºltimos 5 intentos                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ List<AuthAttempt> recentAttempts =                           â”‚
â”‚     authAttemptRepository.findLatestAttemptsByUser(          â”‚
â”‚         user.getId(),                                        â”‚
â”‚         PageRequest.of(0, 5)  // Ãšltimos 5                   â”‚
â”‚     );                                                       â”‚
â”‚                                                              â”‚
â”‚ Query ejecutada:                                             â”‚
â”‚   SELECT * FROM attempt_auth                                 â”‚
â”‚   WHERE use_id = ?                                           â”‚
â”‚   ORDER BY att_occurred DESC                                 â”‚
â”‚   LIMIT 5                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”œâ”€â–º Si hay menos de 5 intentos
                            â”‚   â””â”€â–º return false (no bloquear)
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 3: Verificar que TODOS sean fallos                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ boolean allFailed = recentAttempts.stream()                  â”‚
â”‚     .noneMatch(AuthAttempt::isAttSuccess);                   â”‚
â”‚                                                              â”‚
â”‚ // Verifica que attSuccess == false en los 5                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”œâ”€â–º Si hay algÃºn Ã©xito
                            â”‚   â””â”€â–º return false (no bloquear)
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 4: Verificar ventana temporal (30 minutos)              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ Instant oldestAttemptTime =                                  â”‚
â”‚     recentAttempts.getLast().getAttOccurred();               â”‚
â”‚                                                              â”‚
â”‚ Instant lockoutThreshold =                                   â”‚
â”‚     Instant.now().minus(30, ChronoUnit.MINUTES);             â”‚
â”‚                                                              â”‚
â”‚ if (oldestAttemptTime.isBefore(lockoutThreshold)) {          â”‚
â”‚     // El intento mÃ¡s antiguo fue hace mÃ¡s de 30 min        â”‚
â”‚     return false; // NO bloquear                             â”‚
â”‚ }                                                            â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ EJEMPLO:                                        â”‚          â”‚
â”‚ â”‚ Ahora: 14:30                                   â”‚          â”‚
â”‚ â”‚ Threshold: 14:00 (30 min atrÃ¡s)               â”‚          â”‚
â”‚ â”‚                                                 â”‚          â”‚
â”‚ â”‚ Intentos:                                       â”‚          â”‚
â”‚ â”‚ 1. 14:28 âŒ                                     â”‚          â”‚
â”‚ â”‚ 2. 14:25 âŒ                                     â”‚          â”‚
â”‚ â”‚ 3. 14:20 âŒ                                     â”‚          â”‚
â”‚ â”‚ 4. 14:15 âŒ                                     â”‚          â”‚
â”‚ â”‚ 5. 14:10 âŒ â† MÃ¡s antiguo (14:10 > 14:00) âœ…   â”‚          â”‚
â”‚ â”‚                                                 â”‚          â”‚
â”‚ â”‚ â†’ SÃ bloquear (todos en ventana de 30 min)    â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ CONTRAEJEMPLO:                                  â”‚          â”‚
â”‚ â”‚ Ahora: 14:30                                   â”‚          â”‚
â”‚ â”‚ Threshold: 14:00                               â”‚          â”‚
â”‚ â”‚                                                 â”‚          â”‚
â”‚ â”‚ Intentos:                                       â”‚          â”‚
â”‚ â”‚ 1. 14:28 âŒ                                     â”‚          â”‚
â”‚ â”‚ 2. 14:15 âŒ                                     â”‚          â”‚
â”‚ â”‚ 3. 14:05 âŒ                                     â”‚          â”‚
â”‚ â”‚ 4. 13:55 âŒ â† MÃ¡s antiguo (13:55 < 14:00) âŒ   â”‚          â”‚
â”‚ â”‚ 5. 13:50 âŒ                                     â”‚          â”‚
â”‚ â”‚                                                 â”‚          â”‚
â”‚ â”‚ â†’ NO bloquear (no todos en ventana)            â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼ Todas las condiciones cumplidas
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 5: Bloquear cuenta                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ return blockAccount(user);                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CÃ³digo**: `AccountLockService.java:77-111`

---

#### 5.2 Bloquear la cuenta

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AccountLockService.blockAccount(user)                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ EJECUCIÃ“N DEL BLOQUEO                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 1: Cambiar estado de cuenta                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ user.setState(AccountState.INACTIVE);                        â”‚
â”‚ userRepository.save(user);                                   â”‚
â”‚                                                              â”‚
â”‚ UPDATE app_users                                             â”‚
â”‚ SET state = 'INACTIVE'                                       â”‚
â”‚ WHERE id = ?                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 2: Enviar email de notificaciÃ³n                         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ try {                                                        â”‚
â”‚     String email = user.getRegister().getEmail();            â”‚
â”‚     if (email != null && !email.isBlank()) {                 â”‚
â”‚         emailService.sendAccountBlockedNotice(email);        â”‚
â”‚     }                                                        â”‚
â”‚ } catch (Exception mailEx) {                                 â”‚
â”‚     logger.warn("No se pudo enviar correo...");              â”‚
â”‚ }                                                            â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ EMAIL ENVIADO:                                  â”‚          â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚          â”‚
â”‚ â”‚ Para: usuario@example.com                      â”‚          â”‚
â”‚ â”‚ Asunto: Cuenta bloqueada por seguridad         â”‚          â”‚
â”‚ â”‚                                                 â”‚          â”‚
â”‚ â”‚ Tu cuenta ha sido bloqueada tras mÃºltiples     â”‚          â”‚
â”‚ â”‚ intentos fallidos de inicio de sesiÃ³n.         â”‚          â”‚
â”‚ â”‚                                                 â”‚          â”‚
â”‚ â”‚ Para recuperar tu cuenta, usa la opciÃ³n de     â”‚          â”‚
â”‚ â”‚ recuperaciÃ³n de contraseÃ±a.                    â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 3: Registrar log estructurado                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ logger.warn("Cuenta bloqueada por seguridad. " +             â”‚
â”‚     "Usuario: {}, RUT: {}-{}, intentos: {}, " +              â”‚
â”‚     "ventana_min: {}, ts: {}",                               â”‚
â”‚     user.getId(),                                            â”‚
â”‚     user.getRutGeneral(),                                    â”‚
â”‚     user.getVerificationDigit(),                             â”‚
â”‚     5,  // MAX_FAILED_ATTEMPTS                               â”‚
â”‚     30, // LOCKOUT_DURATION_MINUTES                          â”‚
â”‚     Instant.now()                                            â”‚
â”‚ );                                                           â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ LOG GENERADO:                                   â”‚          â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚          â”‚
â”‚ â”‚ [WARN] Cuenta bloqueada por seguridad.         â”‚          â”‚
â”‚ â”‚        Usuario: 123, RUT: 12345678-9,          â”‚          â”‚
â”‚ â”‚        intentos: 5, ventana_min: 30,           â”‚          â”‚
â”‚ â”‚        ts: 2025-01-15T14:30:00Z                â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                      return true
```

**CÃ³digo**: `AccountLockService.java:119-147`

---

### 6ï¸âƒ£ CÃLCULO DE INTENTOS RESTANTES

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthService.calculateRemainingAttempts(user)                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ ALGORITMO DE CONTADOR DINÃMICO                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 1: Determinar punto de reinicio del contador            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ Instant thirtyMinutesAgo =                                   â”‚
â”‚     Instant.now().minus(30, ChronoUnit.MINUTES);             â”‚
â”‚                                                              â”‚
â”‚ Instant lastSuccess =                                        â”‚
â”‚     authAttemptService.findLastSuccessAt(user.getId());      â”‚
â”‚                                                              â”‚
â”‚ // Reiniciar desde el mÃ¡s reciente:                          â”‚
â”‚ // - Ãšltimo login exitoso, O                                 â”‚
â”‚ // - Hace 30 minutos                                         â”‚
â”‚                                                              â”‚
â”‚ Instant since = (lastSuccess != null &&                      â”‚
â”‚                  lastSuccess.isAfter(thirtyMinutesAgo))      â”‚
â”‚     ? lastSuccess        // âœ… Hay login exitoso reciente    â”‚
â”‚     : thirtyMinutesAgo;  // âŒ No hay, usar ventana 30min    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 2: Contar fallos desde el punto de reinicio             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ long failedCount =                                           â”‚
â”‚     authAttemptService.countFailedAttemptsSince(             â”‚
â”‚         user.getId(),                                        â”‚
â”‚         since                                                â”‚
â”‚     );                                                       â”‚
â”‚                                                              â”‚
â”‚ Query ejecutada:                                             â”‚
â”‚   SELECT COUNT(*) FROM attempt_auth                          â”‚
â”‚   WHERE use_id = ?                                           â”‚
â”‚     AND att_success = false                                  â”‚
â”‚     AND att_occurred > ?  -- since                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 3: Calcular intentos restantes                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ return Math.max(0, 5 - (int)failedCount);                    â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ EJEMPLOS:                                       â”‚          â”‚
â”‚ â”‚                                                 â”‚          â”‚
â”‚ â”‚ failedCount = 0 â†’ remaining = 5                â”‚          â”‚
â”‚ â”‚ failedCount = 1 â†’ remaining = 4                â”‚          â”‚
â”‚ â”‚ failedCount = 2 â†’ remaining = 3                â”‚          â”‚
â”‚ â”‚ failedCount = 3 â†’ remaining = 2                â”‚          â”‚
â”‚ â”‚ failedCount = 4 â†’ remaining = 1                â”‚          â”‚
â”‚ â”‚ failedCount = 5 â†’ remaining = 0 (BLOQUEAR)     â”‚          â”‚
â”‚ â”‚ failedCount = 6 â†’ remaining = 0                â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CÃ³digo**: `AuthService.java:275-287`

---

### 7ï¸âƒ£ RESPUESTA AL CLIENTE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CASO 1: Cuenta bloqueada (5 fallos)                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ HTTP 403 Forbidden                                           â”‚
â”‚ {                                                            â”‚
â”‚   "error": "ACCOUNT_BLOCKED"                                 â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend (LoginComponent) maneja el error                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ if (code === 'ACCOUNT_BLOCKED') {                            â”‚
â”‚     this.remainingAttempts.set(0);                           â”‚
â”‚     this.blockedDialogMessage.set(                           â”‚
â”‚         'Tu cuenta ha sido bloqueada por seguridad. ' +      â”‚
â”‚         'Te enviamos un correo con instrucciones...'         â”‚
â”‚     );                                                       â”‚
â”‚     this.blockedDialogOpen.set(true);                        â”‚
â”‚ }                                                            â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚          â”‚
â”‚ â”‚  â”‚ âš ï¸  Cuenta Bloqueada                â”‚      â”‚          â”‚
â”‚ â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚          â”‚
â”‚ â”‚  â”‚                                      â”‚      â”‚          â”‚
â”‚ â”‚  â”‚ Tu cuenta ha sido bloqueada por     â”‚      â”‚          â”‚
â”‚ â”‚  â”‚ seguridad. Te enviamos un correo    â”‚      â”‚          â”‚
â”‚ â”‚  â”‚ con instrucciones para recuperarla. â”‚      â”‚          â”‚
â”‚ â”‚  â”‚                                      â”‚      â”‚          â”‚
â”‚ â”‚  â”‚            [Cerrar]                  â”‚      â”‚          â”‚
â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CASO 2: Credenciales incorrectas (1-4 fallos)                â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ HTTP 401 Unauthorized                                        â”‚
â”‚ {                                                            â”‚
â”‚   "error": "BAD_CREDENTIALS",                                â”‚
â”‚   "remainingAttempts": 3  // Ejemplo: 2 fallos previos      â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend muestra mensaje de advertencia                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ if (code === 'BAD_CREDENTIALS') {                            â”‚
â”‚     this.remainingAttempts.set(backendRemainingAttempts);    â”‚
â”‚     this.message.set(                                        â”‚
â”‚         `CREDENCIALES INVALIDAS\n` +                         â”‚
â”‚         `Te quedan ${this.remainingAttempts()} intentos`     â”‚
â”‚     );                                                       â”‚
â”‚ }                                                            â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ âŒ CREDENCIALES INVALIDAS                      â”‚          â”‚
â”‚ â”‚    Te quedan 3 intentos                        â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CÃ³digo**: `AuthService.java:96-100` y `LoginComponent.ts:94-119`

---

## ğŸ”“ Desbloqueo de Cuenta

### Flujo de RecuperaciÃ³n de ContraseÃ±a

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Usuario solicita recuperaciÃ³n de contraseÃ±a                  â”‚
â”‚ POST /auth/password/request                                  â”‚
â”‚ { "email": "usuario@example.com" }                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PasswordRecoveryService.sendRecoveryCode(email)              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ 1. Genera cÃ³digo de 6 dÃ­gitos                                â”‚
â”‚ 2. Guarda en BD (vÃ¡lido 10 minutos)                          â”‚
â”‚ 3. EnvÃ­a cÃ³digo por email                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Usuario verifica cÃ³digo y resetea contraseÃ±a                 â”‚
â”‚ POST /auth/password/reset                                    â”‚
â”‚ {                                                            â”‚
â”‚   "email": "usuario@example.com",                            â”‚
â”‚   "code": "123456",                                          â”‚
â”‚   "newPassword": "nueva_contraseÃ±a_segura"                   â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PasswordRecoveryService.resetPassword()                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ 1. Valida cÃ³digo (existe, no usado, no expirado)             â”‚
â”‚ 2. Hashea nueva contraseÃ±a                                   â”‚
â”‚ 3. Actualiza contraseÃ±a en BD                                â”‚
â”‚ 4. â­ DESBLOQUEA LA CUENTA:                                  â”‚
â”‚    if (user.getState() == AccountState.INACTIVE) {           â”‚
â”‚        user.setState(AccountState.ACTIVE);                   â”‚
â”‚    }                                                         â”‚
â”‚ 5. EnvÃ­a email de confirmaciÃ³n                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                  âœ… Cuenta desbloqueada
               Usuario puede volver a iniciar sesiÃ³n
```

**CÃ³digo**: `PasswordRecoveryService.java:104-127`

---

## ğŸ“Š AuditorÃ­a y Trazabilidad

### Tabla `attempt_auth`

Cada intento de login (exitoso o fallido) se registra en la base de datos:

```sql
CREATE TABLE attempt_auth (
    att_id              BIGINT PRIMARY KEY AUTO_INCREMENT,
    use_id              BIGINT,           -- Usuario que intentÃ³ login
    att_dev_fp          VARCHAR(255),     -- Device fingerprint
    ses_id              BIGINT,           -- SesiÃ³n creada (null si fallÃ³)
    att_success         BOOLEAN NOT NULL, -- Â¿Exitoso?
    att_reason          VARCHAR(40),      -- RazÃ³n (OK, BAD_CREDENTIALS, etc)
    att_occurred        TIMESTAMP NOT NULL -- CuÃ¡ndo ocurriÃ³
);

-- Ãndices para performance
CREATE INDEX idx_attempt_user_occurred ON attempt_auth(use_id, att_occurred DESC);
CREATE INDEX idx_attempt_user_success ON attempt_auth(use_id, att_success, att_occurred);
```

### Ejemplo de Registros

```
att_id | use_id | att_dev_fp | ses_id | att_success | att_reason       | att_occurred
-------|--------|------------|--------|-------------|------------------|-------------------
1      | 123    | fp-abc123  | NULL   | false       | BAD_CREDENTIALS  | 2025-01-15 14:10:00
2      | 123    | fp-abc123  | NULL   | false       | BAD_CREDENTIALS  | 2025-01-15 14:15:00
3      | 123    | fp-abc123  | NULL   | false       | BAD_CREDENTIALS  | 2025-01-15 14:20:00
4      | 123    | fp-abc123  | NULL   | false       | BAD_CREDENTIALS  | 2025-01-15 14:25:00
5      | 123    | fp-abc123  | NULL   | false       | BAD_CREDENTIALS  | 2025-01-15 14:28:00
6      | 123    | fp-abc123  | NULL   | false       | ACCOUNT_BLOCKED  | 2025-01-15 14:30:00
                                                     â””â”€â–º Cuenta ya bloqueada
```

---

## ğŸ” Queries de AnÃ¡lisis

### Obtener Ãºltimos 5 intentos de un usuario

```java
@Query("""
    SELECT a FROM AuthAttempt a
    WHERE a.user.id = :userId
    ORDER BY a.attOccurred DESC
    """)
List<AuthAttempt> findLatestAttemptsByUser(
    @Param("userId") Long userId,
    Pageable pageable
);

// Uso:
List<AuthAttempt> attempts = authAttemptRepository
    .findLatestAttemptsByUser(userId, PageRequest.of(0, 5));
```

### Contar fallos desde una fecha

```java
@Query("""
    SELECT COUNT(a) FROM AuthAttempt a
    WHERE a.user.id = :userId
      AND a.attSuccess = false
      AND a.attOccurred > :since
    """)
long countFailedAttemptsSince(
    @Param("userId") Long userId,
    @Param("since") Instant since
);

// Uso:
Instant thirtyMinutesAgo = Instant.now().minus(30, ChronoUnit.MINUTES);
long failedCount = authAttemptRepository
    .countFailedAttemptsSince(userId, thirtyMinutesAgo);
```

### Obtener Ãºltimo login exitoso

```java
@Query("""
    SELECT MAX(a.attOccurred) FROM AuthAttempt a
    WHERE a.user.id = :userId AND a.attSuccess = true
    """)
Instant findLastSuccessAt(@Param("userId") Long userId);

// Uso:
Instant lastSuccess = authAttemptRepository.findLastSuccessAt(userId);
```

---

## ğŸ¯ Casos de Uso Detallados

### Caso 1: Usuario olvida contraseÃ±a (5 intentos fallidos)

```
Tiempo | AcciÃ³n                          | Estado      | Intentos Restantes
-------|----------------------------------|-------------|-------------------
14:00  | Login fallido (contraseÃ±a mal)   | ACTIVE      | 4
14:05  | Login fallido                    | ACTIVE      | 3
14:10  | Login fallido                    | ACTIVE      | 2
14:15  | Login fallido                    | ACTIVE      | 1
14:20  | Login fallido                    | ACTIVE      | 0
14:20  | âš ï¸ CUENTA BLOQUEADA              | INACTIVE    | 0
14:20  | ğŸ“§ Email enviado                 | INACTIVE    | 0
14:25  | Intento de login                 | INACTIVE    | 0 (403 FORBIDDEN)
14:30  | Solicita recuperaciÃ³n de clave   | INACTIVE    | -
14:35  | Resetea contraseÃ±a               | ACTIVE âœ…   | 5
14:40  | Login exitoso                    | ACTIVE      | 5
```

### Caso 2: Ataque de fuerza bruta lento (evade ventana de 30 min)

```
Tiempo | AcciÃ³n                          | Estado      | Ventana 30min | Bloqueo
-------|----------------------------------|-------------|---------------|--------
13:00  | Login fallido                    | ACTIVE      | Dentro        | NO
13:15  | Login fallido                    | ACTIVE      | Dentro        | NO
13:30  | Login fallido                    | ACTIVE      | Dentro        | NO
14:00  | Login fallido                    | ACTIVE      | Dentro        | NO
14:30  | Login fallido                    | ACTIVE      | âŒ FUERA      | NO
                                                         â””â”€ 13:00 estÃ¡ fuera de ventana

Intentos mÃ¡s antiguos (13:00, 13:15, 13:30) quedan fuera de la ventana
â†’ NO SE BLOQUEA (ventana deslizante protege contra ataques lentos)
```

### Caso 3: Login exitoso reinicia contador

```
Tiempo | AcciÃ³n                          | Fallos desde Ãºltimo Ã©xito
-------|----------------------------------|---------------------------
14:00  | Login exitoso âœ…                 | 0
14:05  | Login fallido                    | 1
14:10  | Login fallido                    | 2
14:15  | Login exitoso âœ…                 | 0 (REINICIADO)
14:20  | Login fallido                    | 1
14:25  | Login fallido                    | 2
14:30  | Login fallido                    | 3
14:35  | Login fallido                    | 4
14:40  | Login fallido                    | 5 â†’ BLOQUEO

Contador se reinicia en cada login exitoso
â†’ Protege contra falsos positivos (usuarios legÃ­timos que olvidan contraseÃ±a ocasionalmente)
```

---

## âš™ï¸ ConfiguraciÃ³n

### ParÃ¡metros Actuales (Hardcoded)

```java
// AccountLockService.java
private static final int MAX_FAILED_ATTEMPTS = 5;
private static final int LOCKOUT_DURATION_MINUTES = 30;

// PasswordRecoveryService.java
private static final int CODE_EXPIRATION_MINUTES = 10;
```

### Mejora Propuesta (Externalizado)

```yaml
# application.yml
naivepay:
  security:
    account-lock:
      max-failed-attempts: 5
      lockout-window-minutes: 30
    password-recovery:
      code-ttl-minutes: 10
```

```java
@ConfigurationProperties(prefix = "naivepay.security.account-lock")
@Validated
public class AccountLockConfig {
    @Min(3) @Max(10)
    private int maxFailedAttempts = 5;

    @Min(5) @Max(120)
    private int lockoutWindowMinutes = 30;
}
```

---

## ğŸ“ˆ MÃ©tricas y Observabilidad

### Logs Generados

```
[INFO]  Login attempt started | eventType=LOGIN_ATTEMPT | identifier=user@** | deviceFingerprint=fp-abc123
[WARN]  Login failed | eventType=LOGIN_FAILED | reason=BAD_CREDENTIALS | userId=123 | remainingAttempts=3
[WARN]  Cuenta bloqueada por seguridad | Usuario: 123 | RUT: 12345678-9 | intentos: 5 | ventana_min: 30
[INFO]  Cuenta desbloqueada tras proceso de recuperaciÃ³n | userId=123
```

### MÃ©tricas Propuestas (Micrometer)

```java
// Contadores
auth.login.attempts.total           // Total de intentos
auth.login.failures.total            // Total de fallos
auth.login.failures.by_reason        // Fallos por razÃ³n (tag: reason)
auth.account.locks.total             // Total de cuentas bloqueadas

// Gauges
auth.accounts.locked.current         // Cuentas bloqueadas actualmente

// Histogramas
auth.login.duration.seconds          // Tiempo de procesamiento de login
auth.failed_attempts.distribution    // DistribuciÃ³n de intentos antes de bloqueo
```

---

## âœ… Fortalezas del DiseÃ±o

1. **SeparaciÃ³n de responsabilidades (SRP)**
   - `AuthService`: CoordinaciÃ³n
   - `AccountLockService`: LÃ³gica de bloqueo
   - `AuthAttemptService`: AuditorÃ­a

2. **Ventana temporal deslizante**
   - Protege contra ataques lentos
   - Perdona errores antiguos

3. **Reinicio tras login exitoso**
   - Evita falsos positivos
   - UX amigable para usuarios legÃ­timos

4. **AuditorÃ­a completa**
   - Cada intento se registra
   - Trazabilidad total

5. **Notificaciones proactivas**
   - Email al bloquear cuenta
   - Email al desbloquear

6. **RecuperaciÃ³n automÃ¡tica**
   - Reseteo de contraseÃ±a desbloquea cuenta
   - No requiere intervenciÃ³n manual

---

## âš ï¸ Ãreas de Mejora

1. **ConfiguraciÃ³n hardcoded**
   - Externalizar parÃ¡metros (5 intentos, 30 min)

2. **Sin rate limiting por IP**
   - Un atacante puede probar mÃºltiples cuentas
   - RecomendaciÃ³n: Limitar requests por IP

3. **Sin CAPTCHA**
   - Vulnerable a bots automatizados
   - RecomendaciÃ³n: CAPTCHA despuÃ©s de 2 fallos

4. **Sin MFA**
   - AutenticaciÃ³n de un solo factor
   - RecomendaciÃ³n: MFA opcional

5. **Email Ãºnico de desbloqueo**
   - Solo recuperaciÃ³n de contraseÃ±a desbloquea
   - RecomendaciÃ³n: Endpoint dedicado `/auth/unlock`

6. **Sin notificaciÃ³n de intentos sospechosos**
   - Usuario no sabe si alguien intenta acceder
   - RecomendaciÃ³n: Email de alerta tras 3 fallos

---

## ğŸ” Recomendaciones de Seguridad

### Implementar Rate Limiting por IP

```java
@Component
public class IpRateLimitFilter extends OncePerRequestFilter {
    private final Map<String, Bucket> ipBuckets = new ConcurrentHashMap<>();

    @Override
    protected void doFilterInternal(HttpServletRequest request, ...) {
        String ip = request.getRemoteAddr();
        Bucket bucket = ipBuckets.computeIfAbsent(ip, k -> createBucket());

        if (!bucket.tryConsume(1)) {
            response.setStatus(429); // Too Many Requests
            return;
        }
        chain.doFilter(request, response);
    }

    private Bucket createBucket() {
        // MÃ¡ximo 20 requests por minuto por IP
        return Bucket.builder()
            .addLimit(Bandwidth.classic(20, Refill.intervally(20, Duration.ofMinutes(1))))
            .build();
    }
}
```

### CAPTCHA despuÃ©s de 2 intentos fallidos

```java
// Frontend: mostrar reCAPTCHA tras 2 fallos
if (remainingAttempts <= 3) {
    this.showCaptcha = true;
}

// Backend: validar token de CAPTCHA
if (failedAttempts >= 2) {
    if (!captchaService.validate(req.getCaptchaToken())) {
        return unauthorized(AuthAttemptReason.CAPTCHA_FAILED);
    }
}
```

### NotificaciÃ³n de actividad sospechosa

```java
// DespuÃ©s de 3 fallos, enviar email de alerta
if (failedCount == 3) {
    emailService.sendSuspiciousActivityAlert(
        user.getRegister().getEmail(),
        deviceFingerprint,
        Instant.now()
    );
}
```

---

## ğŸ“š Referencias del CÃ³digo

| Componente | Archivo | LÃ­neas |
|------------|---------|--------|
| Coordinador principal | `AuthService.java` | 55-110 |
| LÃ³gica de bloqueo | `AccountLockService.java` | 77-147 |
| CÃ¡lculo de intentos | `AuthService.java` | 275-287 |
| Registro de intentos | `AuthAttemptService.java` | 17-27, 36-43 |
| Queries de auditorÃ­a | `AuthAttemptRepository.java` | 22-56 |
| Desbloqueo automÃ¡tico | `PasswordRecoveryService.java` | 104-127 |
| Manejo en frontend | `LoginComponent.ts` | 86-131 |

---

**Documento creado**: 2025-11-05
**Autor**: Claude AI
**VersiÃ³n**: 1.0
